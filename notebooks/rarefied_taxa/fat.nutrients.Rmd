---
title: "fecal fats correlated with nutrients"
output: html_notebook
---

#libraries
```{r}
library(tidyverse)
library(biomformat)
library(compositions)
library(a4Base)
library(openxlsx)

library(corrr)
library(FactoMineR)
library(factoextra)

# if(!requireNamespace("BiocManager", quietly = TRUE))
#     install.packages("BiocManager")
# BiocManager::install("Maaslin2")

library(Maaslin2)
library(ggpubr)
```

# Paths
```{r}
wd <- '../../' 

output_dir = paste0(wd,'results/')
diet.protocols = paste0(output_dir,'diet.protocols/')

data_dir = paste0(wd,'data/')
table_dir = paste0(data_dir, 'tables/')
biom_dir = paste0(data_dir,'silva.feces/')
```

## Create Output Dirs
```{r}
dir.create(output_dir)
dir.create(table_dir)
```

# Data Import
```{r}
#serum
# fats <- read.table(paste0(biom_dir, 'R_serum_lipids.txt'),sep = '\t',header = T,row.names = 1) 


nutr.sum <- read_tsv(paste0(table_dir, 'norm.keto.bls.06.10.tsv'))

nutr.sum$file_name <- gsub(nutr.sum$file_name,pattern='u',replacement = 'U') %>% gsub(pattern = '_',replacement = '.') 
nutr.sum <- nutr.sum%>% as.data.frame(.) %>% column_to_rownames(.,'file_name')

cl.sum <- read_tsv(paste0(table_dir, 'nutrient.cluster.correlation_22.10.tsv')) %>% column_to_rownames(.,'file_name')

conv.sum <- read_tsv(paste0(table_dir, 'conv.cluster.correlation_26.10.tsv'))%>% column_to_rownames(.,'file_name')

nutr.sum.z <- read_tsv(paste0(table_dir, 'norm.keto.bls.17.02.tsv'))%>% column_to_rownames(.,'file_name')
cl.sum.z <- read_tsv(paste0(table_dir, 'nutrient.cluster.correlation_17.02.tsv')) %>% column_to_rownames(.,'file_name')
conv.clust.z <- read_tsv(paste0(table_dir, 'conv.cluster.correlation_17.02.tsv'))%>% column_to_rownames(.,'file_name')

#fatty acid in feces
fatty <- read.xlsx(paste0(data_dir, 'Sum_Short_0034SE.xlsx'))

#cholesterol and derivates in feces
choly <- read.xlsx(paste0(data_dir, 'Sterols_Feces_Fricke_0018FE.xlsx'),rowNames = FALSE)
choly[is.na(choly)] <- 0


fa_feces <- read_tsv(paste0(data_dir, 'FA_feces.txt'),col_names = T)


scfa_stool <- read_tsv(paste0(data_dir, 'SCFA_stool.txt'),col_names = T)

```


correlations between fecal fatty acids, cholesterol and short chain fatty acids and respective nutrients, nutrient clusters and conventional clusters (so all in all 9 correlation matrices are generated by this notebook)

only U1 fecal cholesterol,fatty acids, short chain fatty acids (regular non keto diet) correlations with nutrients (only U1) and PCAs of these correlations ('only U1')

spearman correlation plots between total fecal fats,cholesterol,short chain fatty acids and interesting nutrients ('correlation plots')


#data transformation fats,fatty,chol
z.score standardized fecal cholesterol, fatty acids, scfa
```{r}
##data preparation
chol.sub <- dplyr::select(choly,starts_with(c('Sample','Sum','Total'))) %>% .[-1, ]
chol.sub <- chol.sub[!grepl("U3", chol.sub$Sample.Name),]
chol.sub[is.na(chol.sub)] <- 0
row.names(chol.sub) <- chol.sub$Sample.Name
row.names(chol.sub) <- str_replace(row.names(chol.sub),pattern = 'ST.',replacement = '') %>% 
  str_replace(.,pattern = '0U', replacement = 'U')
chol.samples <- row.names(chol.sub)
chol.sub <- dplyr::select(chol.sub,everything(),-starts_with('Sample'))

fa_feces.sub <- dplyr::select(fa_feces,ends_with(c('sat','SampleID','4','8','Omega3','Omega6','total')))
fa_feces.sub <- fa_feces.sub[!grepl("U3", fa_feces.sub$SampleID),]
fa_feces.sub[is.na(fa_feces.sub)] <- 0
fa_feces.sub <- column_to_rownames(fa_feces.sub,'SampleID')
row.names(fa_feces.sub) <- str_replace(row.names(fa_feces.sub),pattern = 'ST.',replacement = '') %>% 
  str_replace(.,pattern = '0U', replacement = 'U')
fa_feces.sub.samples <- row.names(fa_feces.sub)

scfa.sub <- dplyr::select(scfa_stool,ends_with(c('Acetate','SampleID','Propionate','Butyrate','Iso.Butyrate','Total.SCFA')))
scfa.sub <- scfa.sub[!grepl("U3", scfa.sub$SampleID),]
scfa.sub[is.na(scfa.sub)] <- 0
scfa.sub <- column_to_rownames(scfa.sub,'SampleID')
row.names(scfa.sub) <- str_replace(row.names(scfa.sub),pattern = 'ST.',replacement = '') %>% 
  str_replace(.,pattern = '0U', replacement = 'U')
scfa.sub.samples <- row.names(scfa.sub)


##z.score
chol.sub <- data.matrix(chol.sub)
chol.sub.z <- apply(chol.sub,2,scale) %>% as.data.frame(.)
chol.sub.z <- cbind(chol.samples,chol.sub.z)

fa_feces.sub <- data.matrix(fa_feces.sub)
fa_feces.sub.z <- apply(fa_feces.sub,2,scale) %>% as.data.frame(.)
fa_feces.sub.z <- cbind(fa_feces.sub.samples,fa_feces.sub.z)

scfa.sub <- data.matrix(scfa.sub)
scfa.sub.z <- apply(scfa.sub,2,scale) %>% as.data.frame(.)
scfa.sub.z <- cbind(scfa.sub.samples,scfa.sub.z)

```


#nutrients spearman correlated with cholesterol derivates in feces
input--output
```{r}

# chol.sub.z <- rownames_to_column(chol.sub.z)
colnames(chol.sub.z)[colnames(chol.sub.z) == 'chol.samples'] <- 'file_name'

write_tsv(chol.sub.z,paste0(table_dir,'chol.normalized_20.11.tsv'))
chol.sub.z <- column_to_rownames(chol.sub.z,'file_name')

##change merge input:
#nutr.sum.z  nutrients per sample
#conv.sum.z  conventional clusters per sample
#cl.sum.z    nutreitn cluster per sample

merge.chol.nutr <- chol.sub.z %>% merge(.,nutr.sum.z,by = 'row.names',all.x=T,all.y = T) %>% column_to_rownames(.,'Row.names')

merge.chol.nutr[is.na(merge.chol.nutr)] <- 0
merge.chol.nutr <- dplyr::select(merge.chol.nutr,everything(),-ends_with('rowsum'))

#cl.sum.z   `1.veg.fruit`:`15.cheese`
#nutr.sum.z   `Energie (kcal)`:`Energie, Gesamt (kcal)`
#conv.clust.z   `Alkoholfreie Getränke`:`Wurst, Fleischwaren`
##--> put that into the correlation   valaue_left

cor.test.chol <- merge.chol.nutr %>% 
  pivot_longer(names_to = "variable_right", values_to = "value_right", `Sum.Cholesterol.and.derived.stanols`:`Sum.Plant.Sterols.and.derived.stanols`) %>% 
  pivot_longer(names_to = "variable_left", values_to = "value_left", `Energie (kcal)`:`Energie, Gesamt (kcal)`) %>% 
  group_by(variable_left, variable_right) %>% 
  
  mutate(p.value = broom::tidy(cor.test(value_left, value_right, method = "spearman"))$p.value,
         estimate = broom::tidy(cor.test(value_left, value_right, method = "spearman"))$estimate)

cor.test.chol[is.na(cor.test.chol)] <- 0

p.adj.chol <- subset(cor.test.chol,select = `p.value`) %>% data.matrix(.) %>% p.adjust(.,method = 'fdr')
r.cor.chol <- subset(cor.test.chol,select = `estimate`) %>% data.matrix(.)

#x axis log2 correlation

cor.test.log.chol <- log2(r.cor.chol) %>% as.numeric(.)
cor.test.log.chol[is.nan(cor.test.log.chol)] <- 0
cor.test.log.chol[is.infinite(cor.test.log.chol)] <- 0
cor.test.log.chol <- as.data.frame(cor.test.log.chol)

r.cor.chol[is.nan(r.cor.chol)] <- 0
r.cor.chol[is.infinite(r.cor.chol)] <- 0
r.cor.chol <- as.data.frame(r.cor.chol)

#y axis -log10 p.value

p.adj.log.chol <- -log10(p.adj.chol)
p.adj.log.chol[is.infinite(p.adj.log.chol)] <- 0
p.adj.log.chol <- as.data.frame(p.adj.log.chol)

cor.test.adj.chol <- cbind(cor.test.chol[ ,c(1,3)],p.adj.log.chol) %>% cbind(.,r.cor.chol) %>% as.data.frame(.)
colnames(cor.test.adj.chol) <- c('sum fecal chol (derivates)','nutrient','p.adj.log','estimate')

##nutreints 'corr.chol.nutr.tsv'
##conventional clusters 'corr.chol.convclust.tsv'
##nutreint clusters  'corr.chol.nutclust.tsv'

# write_tsv(cor.test.adj.chol,paste0(table_dir,'corr.chol.nutr.tsv'))

sig.chol <- cor.test.adj.chol[cor.test.adj.chol$p.adj.log >= -log10(0.050) & cor.test.adj.chol$p.adj.log > 0.00000,]
top.sig.chol <- sig.chol[order(-sig.chol$p.adj.log ),]

df <- row.names(merge.chol.nutr) %>% as.data.frame(.)
colnames(df) <- 'file_name'
df$group <- ifelse(grepl('U2', df$file_name), 'keto', 'a.non-keto')  
df <- column_to_rownames(df,'file_name')


##maaslin
#take care of the input data

##nutrients   chol_maaslin    as output
##conventional clusters  chol.convclust_maaslin    as output
##nutrient clusters    chol.nutclust_maaslin    as output

maaslin.chol <- Maaslin2(input_data = merge.chol.nutr,input_metadata = df,fixed_effects = 'group',output = 'chol_maaslin',
                         min_abundance = -Inf,
                                 normalization = 'NONE',
                                 transform = 'NONE',
                                 standardize = F, 
                                 random_effects = 'row.names')
```

#nutrients with fatty acids in feces
input--output
```{r}

names(fa_feces.sub.z)[names(fa_feces.sub.z) == 'fa_feces.sub.samples'] <- 'file_name'
write_tsv(fa_feces.sub.z,paste0(table_dir,'fa.normalized_20.11.tsv'))
fa_feces.sub.z <- column_to_rownames(fa_feces.sub.z,'file_name')


#merge input
##nutr.sum.z nutrients per samples
##conv.sum.z conventional clusters per samples
##cl.sum.z nutrient clusters per samples

merge.fa.nutr <- fa_feces.sub.z %>% merge(.,nutr.sum.z,by = 'row.names',all.x=T,all.y = T) %>% column_to_rownames(.,'Row.names')

merge.fa.nutr[is.na(merge.fa.nutr)] <- 0

#cl.sum.z   `1.veg.fruit`:`15.cheese`
#nutr.sum.z   `Energie (kcal)`:`Energie, Gesamt (kcal)`
#conv.clust.z   `Alkoholfreie Getränke`:`Wurst, Fleischwaren`
##--> put that into the correlation

cor.test.fa <- merge.fa.nutr %>% 
  pivot_longer(names_to = "variable_right", values_to = "value_right", `sat`:`Omega6`) %>% 
  pivot_longer(names_to = "variable_left", values_to = "value_left", `Energie (kcal)`:`Energie, Gesamt (kcal)`) %>% 
  group_by(variable_left, variable_right) %>% 
  
  mutate(p.value = broom::tidy(cor.test(value_left, value_right, method = "spearman"))$p.value,
         estimate = broom::tidy(cor.test(value_left, value_right, method = "spearman"))$estimate)

cor.test.fa[is.na(cor.test.fa)] <- 0

p.adj.fa <- subset(cor.test.fa,select = `p.value`) %>% data.matrix(.) %>% p.adjust(.,method = 'fdr')
r.cor.fa <- subset(cor.test.fa,select = `estimate`) %>% data.matrix(.)

#x axis log2 correlation

cor.test.log.fa <- log2(r.cor.fa) %>% as.numeric(.)
cor.test.log.fa[is.nan(cor.test.log.fa)] <- 0
cor.test.log.fa[is.infinite(cor.test.log.fa)] <- 0
cor.test.log.fa <- as.data.frame(cor.test.log.fa)

r.cor.fa[is.nan(r.cor.fa)] <- 0
r.cor.fa[is.infinite(r.cor.fa)] <- 0
r.cor.fa <- as.data.frame(r.cor.fa)

#y axis -log10 p.value

p.adj.log.fa <- -log10(p.adj.fa)
p.adj.log.fa[is.infinite(p.adj.log.fa)] <- 0
p.adj.log.fa <- as.data.frame(p.adj.log.fa)

cor.test.adj.fa <- cbind(cor.test.fa[ ,c(2,4)],p.adj.log.fa) %>% cbind(.,r.cor.fa) %>% as.data.frame(.)
colnames(cor.test.adj.fa) <- c('fecal fatty acids','nutrient','p.adj.log','estimate')

#for write_tsv:
#nutrients corr.fa.nutr.tsv
#conventional clusters corr.fa.convclust.tsv
#nutrient clusters corr.fa.nutclust.tsv

# write_tsv(cor.test.adj.fa,paste0(table_dir,'corr.fa.nutr.tsv'))

sig.fa <- cor.test.adj.fa[cor.test.adj.fa$p.adj.log >= -log10(0.050) & cor.test.adj.fa$p.adj.log > 0.00000,]
top.sig.fa <- sig.fa[order(-sig.fa$p.adj.log ),]


##maaslin

#take care of the input data

##nutrients   fa_maaslin    as output
##conventional clusters  fa.convclust_maaslin    as output
##nutrient clusters    fa.nutclust_maaslin    as output

maaslin.fa <- Maaslin2(input_data = merge.fa.nutr,input_metadata = df,fixed_effects = 'group',output = 'fa_maaslin',
                       min_abundance = -Inf,
                                 normalization = 'NONE',
                                 transform = 'NONE',
                                 standardize = F, 
                                 random_effects = 'row.names')


```

#nutrients with scfa in feces
input--output
```{r}
names(scfa.sub.z)[names(scfa.sub.z) == 'scfa.sub.samples'] <- 'file_name'
write_tsv(scfa.sub.z,paste0(table_dir,'scfa.normalized_20.11.tsv'))
scfa.sub.z <- column_to_rownames(scfa.sub.z,'file_name')

#input for correlation cor.test.scfa value_left:
#cl.sum.z   `1.veg.fruit`:`15.cheese`
#nutr.sum.z   `Energie (kcal)`:`Energie, Gesamt (kcal)`
#conv.clust.z   `Alkoholfreie Getränke`:`Wurst, Fleischwaren`
##--> put that into the correlation

#merge input
##nutr.sum.z nutrients per samples
##conv.sum.z conventional clusters per samples
##cl.sum.z nutrient clusters per samples

merge.scfa.nutr <- scfa.sub.z %>% merge(.,nutr.sum.z,by = 'row.names',all.x=T,all.y = T) %>% column_to_rownames(.,'Row.names')

merge.scfa.nutr[is.na(merge.scfa.nutr)] <- 0
merge.scfa.nutr <- dplyr::select(merge.scfa.nutr,everything(),-ends_with('rowsum'))


cor.test.scfa <- merge.scfa.nutr %>% 
  pivot_longer(names_to = "variable_right", values_to = "value_right", `Acetate`:`Butyrate`) %>% 
  pivot_longer(names_to = "variable_left", values_to = "value_left", `Alkoholfreie Getränke`:`Wurst, Fleischwaren`) %>% 
  group_by(variable_left, variable_right) %>% 
  
  mutate(p.value = broom::tidy(cor.test(value_left, value_right, method = "spearman"))$p.value,
         estimate = broom::tidy(cor.test(value_left, value_right, method = "spearman"))$estimate)

cor.test.scfa [is.na(cor.test.scfa )] <- 0

p.adj.scfa <- subset(cor.test.scfa,select = `p.value`) %>% data.matrix(.) %>% p.adjust(.,method = 'fdr')
r.cor.scfa <- subset(cor.test.scfa,select = `estimate`) %>% data.matrix(.)

#x axis log2 correlation

cor.test.log.scfa <- log2(r.cor.scfa) %>% as.numeric(.)
cor.test.log.scfa[is.nan(cor.test.log.scfa)] <- 0
cor.test.log.scfa[is.infinite(cor.test.log.scfa)] <- 0
cor.test.log.scfa <- as.data.frame(cor.test.log.scfa)

r.cor.scfa[is.nan(r.cor.scfa)] <- 0
r.cor.scfa[is.infinite(r.cor.scfa)] <- 0
r.cor.scfa <- as.data.frame(r.cor.scfa)

#y axis -log10 p.value

p.adj.log.scfa <- -log10(p.adj.scfa)
p.adj.log.scfa[is.infinite(p.adj.log.scfa)] <- 0
p.adj.log.scfa <- as.data.frame(p.adj.log.scfa)

cor.test.adj.scfa <- cbind(cor.test.scfa[ ,c(3,5)],p.adj.log.scfa) %>% cbind(.,r.cor.scfa) %>% as.data.frame(.)
colnames(cor.test.adj.scfa) <- c('fecal scfa','cluster','p.adj.log','estimate')

#for write_tsv:
#nutrients corr.scfa.nutr.tsv
#conventional clusters corr.scfa.convclust.tsv
#nutrient clusters corr.scfa.nutclust.tsv

# write_tsv(cor.test.adj.scfa,paste0(table_dir,'corr.scfa.convclust.tsv'))

sig.scfa <- cor.test.adj.scfa[cor.test.adj.scfa$p.adj.log >= -log10(0.050) & cor.test.adj.scfa$p.adj.log > 0.00000,]
top.sig.scfa <- sig.scfa[order(-sig.scfa$p.adj.log ),]

#maaslin

#take care of the input data

##nutrients   scfa_maaslin    as output
##conventional clusters  scfa.convclust_maaslin    as output
##nutrient clusters    scfa.nutclust_maaslin    as output

maaslin.scfa <- Maaslin2(input_data = merge.scfa.nutr,input_metadata = df,fixed_effects = 'group',output = 'convclust.fa_maaslin',
                       min_abundance = -Inf,
                                 normalization = 'NONE',
                                 transform = 'NONE',
                                 standardize = F, 
                                 random_effects = 'row.names')

```


##only U1
```{r}

fa.U1 <- fa_feces.rel[grepl(pattern = 'U1',row.names(fa_feces.rel)), ]
scfa.U1 <- scfa.rel[grepl(pattern = 'U1',row.names(scfa.rel)), ]
nutr.U1 <- nutr.sum[grepl(pattern = 'U1',row.names(nutr.sum)), ]

##fa

merge.fa.nutr.U1 <- fa.U1 %>% merge(.,nutr.U1,by = 'row.names',all.x=T,all.y = T) 

merge.fa.nutr.U1[is.na(merge.fa.nutr.U1)] <- 0
merge.fa.nutr.U1 <- dplyr::select(merge.fa.nutr.U1,everything(),-ends_with(c('rowsum','total'))) %>% column_to_rownames(.,'Row.names')

# cor.test <- cor(merge.fa.nutr,method = 'spearman')
cor.test.U1 <- merge.fa.nutr.U1 %>% correlate(.,method = 'spearman') 

cor.test.U1 [is.na(cor.test.U1)] <- 0
cor.test.U1 <- cor.test.U1 %>% column_to_rownames(.,'term') 
cor.test.U1 <- cor.test.U1 %>% as.data.frame(.) %>% data.matrix(.)
cor.test.U1 <- cor.test.U1 %>% log2(.)##log2(cor.test.U1) %>%

cor.test.U1[is.nan(cor.test.U1)] <- 0
cor.test.U1[is.infinite(cor.test.U1)] <- 0

##PCA

pca_cor.U1 <- PCA(cor.test.U1, graph = TRUE, scale.unit = T)

pca <-
  factoextra::fviz_pca_biplot(X = pca_cor.U1, geom.var = FALSE,
                            # samples
                            # fill.ind = metadata$item_cat, col.ind = 'black',
                            # pointshape = 21, pointsize = 1.5,
                            geom.ind = c('point','text'), repel = T,
                            # 
                            # # variables
                            # col.var = prop_cat,
                            title = 'PCA non-keto\nspearman correlation fatty acids-nutrients',
                            label = F) + 
  theme(aspect.ratio = 1) 
  

#correlation
cor.fa.U1 <- merge.fa.nutr.U1 %>% 
  pivot_longer(names_to = "variable_right", values_to = "value_right", `sat`:`Omega6`) %>% 
  pivot_longer(names_to = "variable_left", values_to = "value_left", `Energie (kcal)`:`Energie, Gesamt (kcal)`) %>% 
  group_by(variable_left, variable_right) %>% 
  
  summarize(p.value = broom::tidy(cor.test(value_left, value_right, method = "spearman"))$p.value,
         estimate = broom::tidy(cor.test(value_left, value_right, method = "spearman"))$estimate)

cor.fa.U1[is.na(cor.fa.U1)] <- 0

p.adj.fa.U1 <- subset(cor.fa.U1 ,select = `p.value`) %>% data.matrix(.) %>% p.adjust(.,method = 'fdr')
r.cor.fa.U1 <- subset(cor.fa.U1,select = `estimate`) %>% data.matrix(.)

#x axis log2 correlation

cor.test.log.fa.U1 <- log2(r.cor.fa.U1) %>% as.numeric(.)
cor.test.log.fa.U1[is.nan(cor.test.log.fa.U1)] <- 0
cor.test.log.fa.U1[is.infinite(cor.test.log.fa.U1)] <- 0
cor.test.log.fa.U1 <- as.data.frame(cor.test.log.fa.U1)

r.cor.fa.U1[is.nan(r.cor.fa.U1)] <- 0
r.cor.fa.U1[is.infinite(r.cor.fa.U1)] <- 0
r.cor.fa.U1 <- as.data.frame(r.cor.fa.U1)

#y axis -log10 p.value

p.adj.fa.U1 <- -log10(p.adj.fa.U1)
p.adj.fa.U1[is.infinite(p.adj.fa.U1)] <- 0
p.adj.fa.U1 <- as.data.frame(p.adj.fa.U1)

cor.fa <- cbind(cor.fa.U1[ ,c(1,2)],p.adj.fa.U1) %>% cbind(.,r.cor.fa.U1) %>% as.data.frame(.)
colnames(cor.fa) <- c('nutrient','fecal fatty acid','p.adj.log','estimate')

sig.fa.U1 <- cor.fa[cor.fa$p.adj.log >= -log10(0.050) & cor.fa$p.adj.log > 0.00000,]
top.sig.fa.U1 <- cor.fa[order(-cor.fa$p.adj.log ),]
# write_tsv(cor.test.adj.scfa,paste0(table_dir,'corr.scfa.convclust.tsv'))


##scfa
merge.scfa.nutr.U1 <- scfa.U1 %>% merge(.,nutr.U1,by = 'row.names',all.x=T,all.y = T) 

merge.scfa.nutr.U1[is.na(merge.scfa.nutr.U1)] <- 0
merge.scfa.nutr.U1 <- dplyr::select(merge.scfa.nutr.U1,everything(),-ends_with(c('rowsum','total'))) %>% column_to_rownames(.,'Row.names')

# cor.test <- cor(merge.fa.nutr,method = 'spearman')
cor.stest.U1 <- merge.scfa.nutr.U1 %>% correlate(.,method = 'spearman') 
cor.stest.U1 [is.na(cor.stest.U1)] <- 0
cor.stest.U1 <- cor.stest.U1 %>% column_to_rownames(.,'term') 
cor.stest.U1 <- cor.stest.U1 %>% as.data.frame(.) %>% data.matrix(.) ##log2(cor.test.U1) %>%

cor.stest.U1 <- cor.stest.U1 %>% log2(.)##log2(cor.test.U1) %>%


cor.stest.U1[is.nan(cor.stest.U1)] <- 0
cor.stest.U1[is.infinite(cor.stest.U1)] <- 0

##PCA

pca_scor.U1 <- PCA(cor.stest.U1, graph = TRUE, scale.unit = T)


spca <-
  factoextra::fviz_pca_biplot(X = pca_scor.U1, geom.var = FALSE,
                            # samples
                            # fill.ind = metadata$item_cat, col.ind = 'black',
                            # pointshape = 21, pointsize = 1.5,
                            geom.ind = c('point','text'), repel = T,
                            # 
                            # # variables
                            # col.var = prop_cat,
                            title = 'PCA non-keto spearman correlation matrix',
                            label = F) + 
  theme(aspect.ratio = 1) 
# ggsave(p, filename = paste0(output_dir, 'BLS.All.pdf'), device = 'pdf', width = 15, height = 10, dpi = 300)

#correlation
cor.scfa.U1 <- merge.scfa.nutr.U1 %>% 
  pivot_longer(names_to = "variable_right", values_to = "value_right", `Acetate`:`Total.SCFA`) %>% 
  pivot_longer(names_to = "variable_left", values_to = "value_left", `Energie (kcal)`:`Energie, Gesamt (kcal)`) %>% 
  group_by(variable_left, variable_right) %>% 
  
  summarize(p.value = broom::tidy(cor.test(value_left, value_right, method = "spearman"))$p.value,
         estimate = broom::tidy(cor.test(value_left, value_right, method = "spearman"))$estimate)

cor.scfa.U1[is.na(cor.scfa.U1)] <- 0

p.adj.scfa.U1 <- subset(cor.scfa.U1 ,select = `p.value`) %>% data.matrix(.) %>% p.adjust(.,method = 'fdr')
r.cor.scfa.U1 <- subset(cor.scfa.U1,select = `estimate`) %>% data.matrix(.)

#x axis log2 correlation

cor.test.log.scfa.U1 <- log2(r.cor.scfa.U1) %>% as.numeric(.)
cor.test.log.scfa.U1[is.nan(cor.test.log.scfa.U1)] <- 0
cor.test.log.scfa.U1[is.infinite(cor.test.log.scfa.U1)] <- 0
cor.test.log.scfa.U1 <- as.data.frame(cor.test.log.scfa.U1)

r.cor.scfa.U1[is.nan(r.cor.scfa.U1)] <- 0
r.cor.scfa.U1[is.infinite(r.cor.scfa.U1)] <- 0
r.cor.scfa.U1 <- as.data.frame(r.cor.scfa.U1)

#y axis -log10 p.value

p.adj.scfa.U1 <- -log10(p.adj.scfa.U1)
p.adj.scfa.U1[is.infinite(p.adj.scfa.U1)] <- 0
p.adj.scfa.U1 <- as.data.frame(p.adj.scfa.U1)

cor.scfa <- cbind(cor.scfa.U1[ ,c(1,2)],p.adj.scfa.U1) %>% cbind(.,r.cor.scfa.U1) %>% as.data.frame(.)
colnames(cor.scfa) <- c('nutrient','fecal scfa','p.adj.log','estimate')

sig.scfa.U1 <- cor.scfa[cor.scfa$p.adj.log >= -log10(0.050) & cor.scfa$p.adj.log > 0.00000,]
top.sig.scfa.U1 <- cor.scfa[order(-cor.scfa$p.adj.log ),]
```

###correlation plots
```{r}
##Total.Sterols in feces and Cholesterol in diet

ggscatter(merge.chol.nutr,x='Total.Sterols',y='Cholesterin',
          add = 'reg.line',conf.int = TRUE,
          cor.coef = TRUE,cor.method = 'spearman',xlab = 'total sterols feces', ylab = 'dietary cholesterol')
```
```{r}
##total fecal fatty acids and Fett

fa <- ggscatter(merge.fa.nutr,x='total',y='Fett',
          add = 'reg.line',conf.int = TRUE,
          cor.coef = TRUE,cor.method = 'spearman',xlab = 'fecal fatty acids', ylab = 'dietary fats')

sat <- ggscatter(merge.fa.nutr,x='sat',y='Gesättigte Fettsäuren',
          add = 'reg.line',conf.int = TRUE,
          cor.coef = TRUE,cor.method = 'spearman',xlab = 'fecal saturated fatty acids', ylab = 'dietary saturated fats')

unsat <- ggscatter(merge.fa.nutr,x='mono.unsat',y='Einfach ungesättigte Fettsäuren',
          add = 'reg.line',conf.int = TRUE,
          cor.coef = TRUE,cor.method = 'spearman',xlab = 'fecal mono unsaturated fatty acids', ylab = 'dietary mono unsaturated fats')
```

```{r}
##scfa and fiber

fiber <- ggscatter(merge.scfa.nutr,x='Total.SCFA',y='Ballaststoffe',
          add = 'reg.line',conf.int = TRUE,
          cor.coef = TRUE,cor.method = 'spearman',xlab = 'fecal scfa', ylab = 'dietary fibers')

ggscatter(merge.scfa.nutr,x='Total.SCFA',y='Wasserlösliche Ballaststoffe',
          add = 'reg.line',conf.int = TRUE,
          cor.coef = TRUE,cor.method = 'spearman',xlab = 'fecal scfa', ylab = 'dietary soluble fibers')

ggscatter(merge.scfa.nutr,x='Total.SCFA',y='Wasserunlösliche Ballaststoffe',
          add = 'reg.line',conf.int = TRUE,
          cor.coef = TRUE,cor.method = 'spearman',xlab = 'fecal scfa', ylab = 'dietary unsoluble fibers')


```

